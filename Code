#include <Servo.h>


/* -------Code Citations------
https://docs.arduino.cc/built-in-examples/sensors/Ping
^^^ used to figure out how distance sensors work
Mr. Fowlers Videos - used to figure out LED's and Servo

*/
float prevousMillis = millis();
float timer = 2000;
int pingPin = 9;
int buzzerPin = 7;
int buttonPin = 11;
Servo headMove;
boolean buttonState;
int loopCondition;
void setup()
{
  Serial.begin(9600);
  pinMode(12, OUTPUT);
  pinMode(13, OUTPUT);
  pinMode(11, OUTPUT);
  headMove.attach(8, 500, 2500);
 Serial.println("Welcome to Red-Light, Green-Light");
 Serial.println("Please 'Shift-Click' the button to begin");
  }


void loop()
{
  buttonState = digitalRead(buttonPin);
  float duration, cm;
  pinMode(pingPin, OUTPUT);
  digitalWrite(pingPin, LOW);
  delayMicroseconds(2);
  digitalWrite(pingPin, HIGH);
  delayMicroseconds(5);
  digitalWrite(pingPin, LOW);
  pinMode(pingPin, INPUT);
  duration = pulseIn(pingPin, HIGH);
   // convert the time into a distance
  cm = microsecondsToCentimeters(duration);
  
  if (buttonState == HIGH){
    loopCondition = 1;
  }
    if (loopCondition){
     
    greenLight();
    if (millis() > 15000){
      int prevPos = cm;
      delay(3000);
      redLight();
  	pinMode(pingPin, OUTPUT);
  	digitalWrite(pingPin, LOW);
  	delayMicroseconds(2);
  	digitalWrite(pingPin, HIGH);
  	delayMicroseconds(5);
  	digitalWrite(pingPin, LOW);
  	pinMode(pingPin, INPUT);
    duration = pulseIn(pingPin, HIGH);
   // convert the time into a distance
  cm = microsecondsToCentimeters(duration);
      int currPos = cm;
      if (prevPos == currPos || prevPos == currPos + 1 || prevPos == currPos + 2 && cm > 15 ){
      	playerSafe();
      }
      else {
        if (cm > 15){
        playerKill();
        }
      }
    }
    if (cm < 15){
      	playerSuccess();
     	resetProgram();
    }
      if (millis() > 300000){
        Serial.println("You are dead.");
      }
  }
}


/* -----Functions-----*/


void greenLight(){
digitalWrite(12, LOW);
digitalWrite(13, HIGH);
tone(buzzerPin, 500, 250); // suspensful sound
delay(1500);
tone(buzzerPin, 1000, 250); // suspensful sound
delay(1500);
}

void redLight(){

digitalWrite(12, HIGH);
digitalWrite(13, LOW);
tone(buzzerPin, 50, 2500);
delay(1500);
}

void playerSafe(){
    Serial.println("You are safe...for now");
}

void playerKill(){
  
  Serial.println("You are dead!");
  for (int pos = 0; pos<= 180; pos+=1){
    headMove.write(pos);
    delay(15);
  }
  
}

void playerSuccess(){
  Serial.println("Congratulations, you've survived");
  buttonState == LOW;
}

void resetProgram (){
  noTone(buzzerPin);
  digitalWrite(12, LOW);
  digitalWrite(13, LOW);
  
}

long microsecondsToCentimeters(long microseconds) {
  // The speed of sound is 340 m/s or 29 microseconds per centimeter.
  // The ping travels out and back, so to find the distance of the object we
  // take half of the distance travelled.
  return microseconds / 29 / 2;
}

